---
title: "EDA Project"
author: "Joe Stoica, Conor Devins, Geno Kim"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  pdf_document:
    fig_width: 6
    fig_height: 4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      cache = TRUE, 
                      message = FALSE,
                      warning = FALSE)
library(tidyverse)
library(lubridate)
library(ggthemes)
library(ggmosaic)
```


```{r ggplot theme}
# Set global ggplot theme
theme_set(theme_fivethirtyeight() + theme(axis.title = element_text()))
```

# Statement of goals.
## What questions are you trying to address? 
Some preliminary questions 

### 1.	What is the relationship between perceived side effects and overall satisfaction? 

### 2.	What is the relationship between perceived effectiveness and overall satisfaction? 

### 3.	What is the relation between perceived side effects and perceived effectiveness? 
#### a.	Though intuitively one may assume that more severe side effects would be associated with lower perceived effectiveness, it is also possible that effectiveness-sideeffect trade-offs are nonetheless perceived as a net benefit to the patient (where perceived benefits of the drug for daily life quality outweigh their negative side effects). Are there certain classes of drugs or specific drugs where the  relationships are different or does it hold true across all drugs?

### 4. What is the breakdown of the types of drugs used for treating depression (or other mood disorders).

#### a. This can be a simple pie chart showing the relative proportions of serotonin-reuptake inhibiting drugs (SRIs), norepinephrine-mechanism drugs (NRIs), Amphetamines (AMP), etc…

### 5. How do certain classes of drugs compare in terms of their perceived side effects, effectiveness and overall satisfaction?

#### a. SRIs and NRIs are probably the most popular of options, but are they actually superior along   these dimensions of perception? 

#### b. Can probably do Multinomial regression to address this question; if we do this, may be worth excluding some drug classes that have very few cases, and focusing on those classes that represent a  sizeable portion of the data. These analyses are covered in Lecture 25, slide 28. 


## Why do you care?   

## Why should we care?

# Description of your data.
## In addition to graphical displays, this should include verbal descriptions of what your variables are, who the individuals in your data from, and how they were selected/sampled. If you have many variables, you don’t have to describe all of them, just pick out some key ones.

The data we chose to use is the Drug Review Dataset from the UCI Machine Learning
Repository. The data focuses on pharmaceutical drug users ratings and reviews of
certain drugs they've taken. 

The data was compiled by gathering the reviews from druglib.com, which is "a
comprehensive drug database organized by relevance to specific drugs." (TODO make footnote for http://www.druglib.com/). It allows people who have used a specific drug to rate 
the drug based on their experience. 

(TODO explain how we removed people and have that code)

(TODO change observations #) Our data has five columns with 369 different observations:

DrugName: the name of the drug

Satisfaction: Rating (10-point scale, 10 being highest satisfaction)

Effectiveness:
1 - Ineffective
2 - Marginally Effective
3 - Moderately Effective
4 - Considerably Effective
5 - Highly Effective


Side Effects: 
1 - Extremely Severe Side Effects
2 - Severe Side Effects
3 - Moderate Side Effects
4 - Mild Side Effects
5 - No Side Effects

Type: Chemical type of the drug  

# Answering your questions.
## This is the most important criterion. It will probably include (but is not limited to) fitting a statistical model or models of some kind, and showing that these models tell you something of interest. You should do the following (not necessarily in this order):

(TODO what's our main question)


```{r data import}
# From https://archive.ics.uci.edu/ml/datasets/Drug+Review+Dataset+%28Druglib.com%29#
#drugs <- read_csv("drugData.csv")
drugs_test <- read_csv(file = 'drugLibTest_raw.csv')

drugs_train <- read_csv(file = 'drugLibTrain_raw.csv')

drugs <- rbind(drugs_test, drugs_train) %>% as.tibble() 
```

1. filter all rows for which the condition is for anything related to “depression”
so basically just look for the string “depression” in that column where condition is listed.
this includes depression + any other comorbidities
2. delete the comments column where people describe their experience w/ the drug etc.
3. for the drug names (e.g. lexapro etc.) any drug that has a hyphenated add-on such as drugname-xr or whatever, just remove that hyphenated part so you’re just left with “drugname”, for the simplicity we’re gonna ignore different versions of the same drug (paxil-xr vs paxil)
just treat paxil-xr as belonging to paxil

and finally, the column that i added but was not part of the original data set was drug pharmacology (e.g. SRI, NRI, Amphetamines, etc.)

i basically had to manually make a table of contents for which family each drug name belonged to
but u won’t need to since you can find out that grouping from the csv file i uploaded
all those steps summarize what was done to get the data in the form it is now.

```{r data cleaning}
df <- drugs %>% 
  # keep people who are depressed
  filter(str_detect(condition, 'epress')) %>% 
  # get rid of unnecessary columns
  select(-benefitsReview, -sideEffectsReview, -commentsReview, -X1, -condition) %>% 
  # recode likert to 1-5 scale 
  mutate(effectiveness = case_when(
    effectiveness == "Highly Effective" ~ 5,
    effectiveness == "Marginally Effective" ~ 2, 
    effectiveness == "Moderately Effective" ~ 3, 
    effectiveness == "Considerably Effective" ~ 4,
    TRUE ~ 1)) %>% 
  mutate(sideEffects = case_when(
    sideEffects == "Extremely Severe Side Effects" ~ 1, 
    sideEffects == "Severe Side Effects" ~ 2, 
    sideEffects == "Moderate Side Effects" ~ 3, 
    sideEffects == "Mild Side Effects" ~ 4, 
    TRUE ~ 5)) %>% 
  mutate(urlDrugName = case_when(
    urlDrugName == "wellbutrin-xl" ~ "wellbutrin",
    urlDrugName == "wellbutrin-sr" ~ "wellbutrin",
    urlDrugName == "paxil-cr" ~ "paxil",
    urlDrugName == "effexor-xr" ~ "effexor",
    TRUE ~ urlDrugName
  ))

names(df)[1] <- "drug"

```

```{r make drug table}
SRI_list <- c("Celexa",
              "Citalopram",
              "Lexapro",
              "Paxil",
              "Prozac",
              "Zoloft",
              "Sarafem",
              "Symbyax",
              "Desyrel",
              "Trazodone")

AAP_list = c("Abilify", "Zyprexa","seroquel")


AMP_list <- c("Adderall",
              "Dextroamphetamine",
              "Vyvanse",
              "ritalin")

OPD_list <-  c("buprenorphine", "tramadol")

NRI_list <- c("Concerta",
              "Wellbutrin",
              "Effexor",
              "Serzone",
              "Pristiq",
              "Cymbalta")

BNZ_list <- c("Diazepam",
              "Klonopin",
              "Valium",
              "Xanax")

TCA_list <-  c("Elavil",
               "nortriptyline",
               "Pamelor")

MOAI_list <- c("Emsam",
               "Nardil")

MISC_list <- c("Lamictal",
               "Lamotrigine",
               "Lithium-Carbonate",
               "Mirtazapine",
               "Gabapentine",
               "neurontin",
               "prempro",
               "remeron",
               "Sular",
               "synthroid",
               "tirosint",
               "topamax")

type_list <- c(rep("AAP", 3), rep("AMP", 4), rep("BNZ", 4), rep("MISC", 12), rep("MOAI", 2),
               rep("NRI", 6), rep("OPD", 2), rep("SRI", 10), rep("TCA", 3))
drug_list <- c(AAP_list, AMP_list, BNZ_list, MISC_list, MOAI_list, NRI_list, OPD_list, SRI_list, TCA_list)

drug_table <- data.frame(drug = tolower(drug_list), type = type_list)

# join drug data with drug type
df <- df %>% left_join(drug_table, by = "drug")
```



```{r }
df %>% 
  ggplot(aes(factor(sideEffects), fill = factor(rating))) +
  geom_bar(position = "fill") +
  theme(legend.position = "right",
        legend.direction = "vertical") +
  guides(fill = guide_legend(title = "Satisfaction")) +
  ylab("Proportion") +
  xlab("Side Effects Ratings") + 
  coord_flip() +
  ggtitle("Drug Side Effects Ratings and Overall Satisfaction")+
  scale_fill_viridis_d()
```

The above plot shows that the worse the side effects are, the least satisfied the
subjects were. (TODO more explanation maybe)



```{r}
df %>% 
  ggplot(aes(effectiveness, fill = factor(rating))) +
  geom_bar(position = "fill") +
  theme(legend.position = "right",
        legend.direction = "vertical") +
  guides(fill = guide_legend(title = "Satisfaction")) +
  ylab("Proportion") +
  xlab("Effectiveness") + 
  coord_flip() +
  ggtitle("Perceived Drug Effectiveness and Overall Satisfaction") +
  scale_fill_viridis_d()
```
The above plot shows that the more effective, the more satisfied the
subjects were. (TODO more explanation maybe)

```{r}
df %>%
  ggplot(aes(effectiveness, fill = factor(sideEffects))) +
  geom_bar(position = "fill") + 
  theme(legend.position = "right",
        legend.direction = "vertical") +
  guides(fill = guide_legend(title = "Side Effects Rating")) +
  ylab("Proportion") +
  xlab("Effectiveness") + 
  coord_flip() +
  ggtitle("Perceived Drug Effectiveness and Side Effects") +
  scale_fill_viridis_d()
```


Show mosaic plot for different patient ratings by drug type

show pie chart of the proportions of different drug types for treating depression-related disability


### State answers to your questions;

### Describe how you came to these answers;

### Explore the implications to your answers. For example, if your answer is a non-trivial model, plot the fit and describe what’s going on in words.

# Identification of work left to do/limitations.
## It’s EDA, so we don’t require perfection. However, you should have a clear idea of what the imperfections in your work are (what doesn’t fit  well?   what  other  variables  would  you  really want  to  know?),  and  how  they  could potentially be addressed.

Set up data frame for mosaic plots
```{r}
x <-  df %>% 
  filter(type %in% c("SRI", "NRI")) %>% 
  droplevels() %>% 
  select(type, effectiveness, sideEffects, rating) %>%
  gather(key = "rating_type", value = "given_score", sideEffects, effectiveness, rating) %>% 
  group_by(type, rating_type) %>% 
  count()

names(x) = c("drug_type", "rating_type", "given_score", "count")
```

Mosaic plot of user overall satisfaction with drug by drug type (SRI vs NRI)
```{r}
x %>%
  filter(rating_type %in% c("rating")) %>%
  mutate(rating_type = case_when(
    rating_type == "rating" ~ "Overall Satisfaction Rating",
    TRUE ~ "Overall Satisfaction Rating")) %>%
  ggplot() +
  geom_mosaic(aes(product(drug_type, rating_type),
                  weight = count,
                  fill = factor(given_score))) +
  theme_fivethirtyeight() +
  guides(fill = guide_legend("Rating",reverse = TRUE)) +
  coord_flip() +
  scale_fill_viridis_d() +
  theme(legend.position = "right", 
        legend.direction = "vertical",
        axis.text.y = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())
```

Mosaic plot of user ratings of drug effectiveness and side effects by drug type (SRI vs NRIs)
```{r}
x %>% 
  filter(rating_type %in% c("effectiveness", "sideEffects")) %>% 
  mutate(rating_type = case_when(
    rating_type == "effectiveness" ~ "User Rating of Effectiveness",
    TRUE ~ "User Rating of Side Effects")) %>% 
  ggplot() +
  geom_mosaic(aes(product(drug_type, rating_type), 
                  weight = count, 
                  fill = factor(given_score)))+
  theme_fivethirtyeight() + 
  guides(fill = guide_legend("Rating",reverse = TRUE)) +
  coord_flip() + 
  facet_grid(. ~ rating_type) + 
  scale_fill_viridis_d() + 
  theme(legend.position = "right", 
        legend.direction = "vertical",
        axis.text.y = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())
```

Show specific drug brand counts within drug types SRI and NRI
```{r}
SRI.drugprev = df %>%
  filter(type %in% c("SRI")) %>%
  select(drug) %>%
  count() %>%
  arrange(desc(freq))

# lock in factor orderings by prevalence
SRI.drugprev$drug <- factor(SRI.drugprev$drug, levels = SRI.drugprev$drug[order(SRI.drugprev$freq)])

ggplot(data = SRI.drugprev, aes(x=drug,y=freq)) +
  geom_bar(stat = "identity") + coord_flip() +
  xlab("Drug Brand") + ylab("Prevalence")
```

```{r}
NRI.drugprev = df %>%
  filter(type %in% c("NRI")) %>%
  select(drug) %>%
  count() %>%
  arrange(desc(freq))

# lock in factor ordering by prevalence
NRI.drugprev$drug <- factor(NRI.drugprev$drug, levels = NRI.drugprev$drug[order(NRI.drugprev$freq)])

ggplot(data = NRI.drugprev, aes(x=drug,y=freq)) +
  geom_bar(stat = "identity") + coord_flip() +
  xlab("Drug Brand") + ylab("Prevalence")
```

