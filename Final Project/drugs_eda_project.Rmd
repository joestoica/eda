---
title: "Examining Patient Evaluations of Antidepressant Drug Use and Efficacy"
author: "Joe Stoica, Conor Devins, Eugene Kim"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
header-includes:
  - \setlength{\parindent}{4em}
  - \setlength{\parskip}{0em}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      cache = TRUE, 
                      message = FALSE,
                      warning = FALSE,
                      fig.align = "center")
library(tidyverse)
library(lubridate)
library(ggthemes)
library(ggmosaic)
library(VGAM)
install.packages("kableExtra")
library(kableExtra)
```


```{r ggplot theme}
# Set global ggplot theme
theme_set(theme_fivethirtyeight() + theme(axis.title = element_text()))
```

# Introduction

According to the 2015 report “Depression and Other Common Mental Disorders: Global Health Estimates” by the World Health Organization, depression is the leading cause of disability and burden of disease worldwide. Evidence-based guidelines generally recommend that second-generation antidepressants (e.g. selective serotonin reuptake inhibitors and selective norepinephrine reuptake inhibitors)—in conjunction with psychotherapy—be taken as the first line of treatment for depression (Anderson et al., 2008; Qaseem, Barry, & Kansagara, 2016; Won et al., 2014). Given the considerably large array of existing pharmacological treatment options for depression and heterogeneity in risk/benefit trade-offs thereof, it is worth examining critical aspects of patients’ subjective treatment experiences across a representative sample of the antidepressant drug landscape.

Research indicates that efforts to maximize treatment benefits for patients with psychiatric illnesses are hampered by poor adherence to prescribed medications (McDonald, Garg, & Haynes, 2002). Among the many different patient factors known to affect adherence to psychiatric treatment (e.g. patient beliefs, stigmas, cost, fears of addiction, etc.), adverse drug side effects are commonly reported as a reason for reluctance to accept or continue pharmacological treatment programs (Fortney et al., 2011; Sansone & Sansone, 2012).  

In order to better understand the choices that patients make when it comes to depression treatment programs, and why they make those choices, this project will focus on three main objectives:

1.  Identify predominant choice of antidepressant drug types and brands.

2.	Examine patients’ risk/benefit evaluations across varying treatment options.

3.  Predict patients' overall satisfaction with a drug based on the drug's effectiveness and side effects.


***

# Description of your data.

```{r data import}
# From https://archive.ics.uci.edu/ml/datasets/Drug+Review+Dataset+%28Druglib.com%29#
drugs_test <- read_csv(file = 'data/drugLibTest_raw.csv')
drugs_train <- read_csv(file = 'data/drugLibTrain_raw.csv')
drugs <- rbind(drugs_test, drugs_train) %>% as.tibble() 
```

```{r sentiment}
# df_sent <- drugs %>%
#   filter(str_detect(condition, 'epress')) %>%
#   select(-c(sideEffectsReview, commentsReview, X1, condition)) %>% 
#   # recode likert to 1-5 scale 
#   mutate(effectiveness = case_when(
#     effectiveness == "Highly Effective" ~ 5,
#     effectiveness == "Marginally Effective" ~ 2, 
#     effectiveness == "Moderately Effective" ~ 3, 
#     effectiveness == "Considerably Effective" ~ 4,
#     TRUE ~ 1)) %>% 
#   mutate(sideEffects = case_when(
#     sideEffects == "Extremely Severe Side Effects" ~ 1, 
#     sideEffects == "Severe Side Effects" ~ 2, 
#     sideEffects == "Moderate Side Effects" ~ 3, 
#     sideEffects == "Mild Side Effects" ~ 4, 
#     TRUE ~ 5)) %>% 
#   mutate(urlDrugName = case_when(
#     urlDrugName == "wellbutrin-xl" ~ "wellbutrin",
#     urlDrugName == "wellbutrin-sr" ~ "wellbutrin",
#     urlDrugName == "paxil-cr" ~ "paxil",
#     urlDrugName == "effexor-xr" ~ "effexor",
#     TRUE ~ urlDrugName
#   ))
# names(df_sent)[1] <- "drug"
# colnames(drugs)

# getSent = function(review) {
#   sentiment <- analyzeSentiment(review)
#   sentBinary <- convertToBinaryResponse(sentiment)$SentimentGI
#   return(as.character(sentBinary))
# }

# This takes really long to execute so leave commented out. 
# for(i in 1:nrow(df_sent)){
#  df_sent$benefitsReview[i] <- getSent(df_sent$benefitsReview[i])
# }
```

```{r data cleaning}
df <- drugs %>% 
  # keep people who are depressed
  filter(str_detect(condition, 'epress')) %>% 
  # get rid of unnecessary columns
  select(-c(sideEffectsReview, benefitsReview, commentsReview, X1, condition)) %>% 
  # recode likert to 1-5 scale 
  mutate(effectiveness = case_when(
    effectiveness == "Highly Effective" ~ 5,
    effectiveness == "Marginally Effective" ~ 2, 
    effectiveness == "Moderately Effective" ~ 3, 
    effectiveness == "Considerably Effective" ~ 4,
    TRUE ~ 1)) %>% 
  mutate(sideEffects = case_when(
    sideEffects == "Extremely Severe Side Effects" ~ 1, 
    sideEffects == "Severe Side Effects" ~ 2, 
    sideEffects == "Moderate Side Effects" ~ 3, 
    sideEffects == "Mild Side Effects" ~ 4, 
    TRUE ~ 5)) %>% 
  mutate(urlDrugName = case_when(
    urlDrugName == "wellbutrin-xl" ~ "wellbutrin",
    urlDrugName == "wellbutrin-sr" ~ "wellbutrin",
    urlDrugName == "paxil-cr" ~ "paxil",
    urlDrugName == "effexor-xr" ~ "effexor",
    TRUE ~ urlDrugName
  ))
names(df)[1] <- "drug"

SRI_list <- c("Celexa",
              "Citalopram",
              "Lexapro",
              "Paxil",
              "Prozac",
              "Zoloft",
              "Sarafem",
              "Symbyax",
              "Desyrel",
              "Trazodone")
AAP_list = c("Abilify", "Zyprexa","seroquel")
AMP_list <- c("Adderall",
              "Dextroamphetamine",
              "Vyvanse",
              "ritalin")
OPD_list <-  c("buprenorphine", "tramadol")
NRI_list <- c("Concerta",
              "Wellbutrin",
              "Effexor",
              "Serzone",
              "Pristiq",
              "Cymbalta")
BNZ_list <- c("Diazepam",
              "Klonopin",
              "Valium",
              "Xanax")
TCA_list <-  c("Elavil",
               "nortriptyline",
               "Pamelor")
MOAI_list <- c("Emsam",
               "Nardil")
MISC_list <- c("Lamictal",
               "Lamotrigine",
               "Lithium-Carbonate",
               "Mirtazapine",
               "Gabapentine",
               "neurontin",
               "prempro",
               "remeron",
               "Sular",
               "synthroid",
               "tirosint",
               "topamax")
type_list <- c(rep("AAP", 3), rep("AMP", 4), rep("BNZ", 4), rep("MISC", 12), rep("MOAI", 2),
               rep("SNRI", 6), rep("OPD", 2), rep("SSRI", 10), rep("TCA", 3))
drug_list <- c(AAP_list, AMP_list, BNZ_list, MISC_list, MOAI_list, NRI_list, OPD_list, SRI_list, TCA_list)
drug_table <- data.frame(drug = tolower(drug_list), type = type_list)

# join drug data with drug type
df <- df %>% left_join(drug_table, by = "drug")

df <- df %>% 
  mutate(type = ifelse(type %in% c("SSRI", "SNRI"), as.character(type), "Other"))
```


For the current research, we utilized a publicly available data set obtained from the UCI Machine Learning Repository, which contains patient reviews for specific drugs being taken to treat various conditions (Gräßer, Kallumadi, Malberg, & Zaunseder, 2018). The authors of the data set obtained the patient drug review data by pooling across multiple online pharmaceutical review sites. Each patient review for a specific drug consisted of the following:
The drug name (brand), overall satisfaction rating, perceived effectiveness rating, side effects rating, the condition being treated, benefits comment, side effects review, and overall comments.
Overall Satisfaction was rated on a scale of 1 to 10, with 10 representing highest possible satisfaction. Perceived Effectiveness and Side Effects ratings were given on a 5-step Likert response scale (Table 1). The remaining review aspects (benefits comment, side effects comment, overall comments) were written responses and excluded from our analyses.

***

**DrugName**: the name of the drug

**Satisfaction**: Rating (10-point scale, 10 being highest satisfaction)

**Effectiveness**:
1 - Ineffective;
2 - Marginally Effective;
3 - Moderately Effective;
4 - Considerably Effective;
5 - Highly Effective

**Side Effects**: 
1 - Extremely Severe Side Effects;
2 - Severe Side Effects;
3 - Moderate Side Effects;
4 - Mild Side Effects;
5 - No Side Effects

**Type**: Chemical type of the drug 

***

Here is a snapshot of our data

```{r}
head(df %>% select(1:5)) %>% kable() %>% kable_styling()
```

The raw dataset included patient reviews on drugs taken for various non-psychiatric (depression-related) medical conditions/needs (e.g. common cold, acid reflux, high cholesterol, contraceptives, etc.). We filtered all cases where depression was at least one of the conditions listed by the patient as a reason for drug treatment. To simplify our analyses and to maximize sample size, we chose not to further subdivide filtered cases by presence or absence of comorbid conditions; cases with condition listed as “depression & anxiety” were not differentiated from those listing only “depression”. This filtering resulted in a total of 499 cases. Next, we converted the perceived effectiveness and side effects ratings responses to be numerically represented on an ordinal scale ranging from 1 to 5, representing the lowest to best possible ratings respectively (Table 1). We also defined an additional categorical variable, “Drug Type”, which was not included in the original data. This variable provides a higher order grouping of specific drug brands in terms of the primary mechanisms of action by which they achieve their pharmacological effects. For example, drugs such as Prozac and Citalopram belong to a family of drugs known as selective serotonin reuptake inhibitors (SSRIs). 


## Choice of Drug Brands and Type

Based on our filtering criteria, we identified 46 distinct drug brands across multiple drug types. One question we aimed to address was how different drug types were distributed across the patient sample, as indexed by the relative number of reviews associated with specific drugs. 

SSRIs and SNRIs accounted for a vast majority of the reviews in the data (Figure 1). Out of the 499 patient reviews, 193 (39%) were for drugs classified as SNRIs, and 237 (47%) for drugs falling under the SSRI category. The “Other” category encompassed drugs spanning several unique types including, but not limited to, monoamine oxidase inhibitors (MOAIs), amphetamines, benzodiazepines, atypical antipsychotics, and tricyclic antidepressants. Although each of the aforementioned drug types are like SSRIs and SNRIs, insofar as they each represent distinct biochemical mechanisms of action, we chose to group all other drugs into a single category due to the relatively small number of reviews available for drugs not accounted for by the two dominant categories. That SSRIs are the most popular choice of antidepressant drug is consistent with existing literature. 

```{r cut BAR.C drug type}
df %>%
  group_by(type) %>%
  count() %>%
  ggplot(aes(as.factor(type),n)) +
  geom_bar(stat = "identity") +
  #theme_light(base_size = 20) +
  theme(panel.grid.major.x = element_blank()) +
  ylab("Count") +
  xlab("Drug Classification")
```

*** 

# Answering Our Questions.

## Simple EDA

We wanted to familiarize ourselves with our data by getting a general sense of the relationships between our variables. 

```{r bar chart for counts}
temp <- df %>% 
  filter(type %in% c("SSRI", "SNRI")) %>% 
  select(drug, type) %>% 
  group_by(drug, type) %>% 
  count() %>% 
  ungroup()

# vec <- temp %>% 
#   arrange(n) %>% 
#   select(drug)
# dput(vec)

# I got it from the vec output, this is ugly 
temp$drug = factor(temp$drug, levels = c("concerta", "desyrel", "serzone", "symbyax", "trazodone", "pristiq", "sarafem", "celexa", "citalopram", "cymbalta",  "zoloft", "paxil", "prozac", "lexapro", "effexor", "wellbutrin"))

temp %>% 
  ggplot(aes(drug, n)) +
  geom_bar(stat = "identity") + 
  coord_flip() + 
  facet_wrap(.~type, scales = "free") +
  theme(panel.grid.major.y = element_blank()) +
  ylab("Count") +
  xlab("Drug Brand Name") + 
  labs(title = "Which Drugs are Reviewed Most in NRI and SRI Groups?") +
  theme_fivethirtyeight()
```

Here we see counts for each drug in their respective drug family type. We didn't include the Other drug category because it has a large amount of different drugs that comprise a relatively small proprotion of the overall data. The SSRI group has a few more drugs than SNRI, SNRI has two drugs that are more frequent than the most frequent SSRI. 

### Satisfaction Measured Against Side Effects and Effectiveness

Next we examined how the users' overall satisfaction are related to the users' reported side effects and effectiveness levels.

```{r STACK BAR SE SATIS}
df %>%
  ggplot(aes(factor(sideEffects), fill = factor(rating))) +
  geom_bar(position = "fill") +
  theme(legend.position = "top",
        legend.direction = "horizontal",
        panel.background = element_blank(),
        plot.background = element_blank(),
        legend.background = element_blank(),
        plot.subtitle = element_text(size = 8, color = "black")) +
  guides(fill = guide_legend(title = "Satisfaction", reverse = TRUE, nrow = 1)) +
  ylab("Proportion") +
  xlab("Side Effects Ratings") +
  coord_flip() +
  labs(title = "Drug Side Effects Ratings and Overall Satisfaction",
       subtitle = "1 - Extremely Severe, 2 - Severe, 3 - Moderate, 4 - Mild, 5 - None")+
  scale_fill_viridis_d()

# ggsave(side_satis_plot, filename = "side_satis_plot.png", height = 9, width = 16)
```

The plot reveals that the worse the side effects are, the least satisfied the subjects were. This generally makes a lot of sense because people who are already feeling bad and are taking medications to mitigate their ailments most likely don't like feeling additionally worse. It's interesting to see how over half of the users reporting no side efects rate the drug 10/10, while almost 80% of users with extremely severe side effects have a satisfaction level of 1.

```{r STACK BAR EFF SATIS}
df %>%
  ggplot(aes(effectiveness, fill = factor(rating))) +
  geom_bar(position = "fill") +
  theme(legend.position = "top",
        legend.direction = "horizontal",
        plot.subtitle = element_text(size = 8, color = "black"),
        panel.background = element_blank(),
        plot.background = element_blank(),
        legend.background = element_blank()) +
  guides(fill = guide_legend(title = "Satisfaction", reverse = TRUE, nrow = 1)) +
  ylab("Proportion") +
  xlab("Effectiveness") +
  labs(title = "How Drugs Effectiveness Affects Satisfaction",
       subtitle = "1 - Ineffective, 2 - Marginally Effective, 3 - Moderately Effective, 4 - Considerably Effective, 5 - Highly Effective") +
  coord_flip() +
  scale_fill_viridis_d() +
  ggtitle("Perceived Drug Effectiveness and Overall Satisfaction")

#ggsave(satis_perc, filename = "satis_perc.png", height = 9, width = 16)
```

The above plot shows that the more effective the drug was, the more satisfied the users were. The response proportions are not as extreme as side effects however. It is worth mentioning the possibility that users have a tendency to select the most extreme values, and it calls into account how accurate a Likert variable can truly be due to its subjective nature. 

```{r make mosiac df}
# Set up data frame for mosaic plots
x <- df %>% 
  select(type, effectiveness, sideEffects, rating) %>%
  gather(key = "rating_type", value = "given_score", sideEffects, effectiveness, rating) %>% 
  group_by(type, rating_type, given_score) %>% 
  count()
names(x) = c("type", "rating_type", "given_score", "count")
x$type = factor(x$type, levels = c("SNRI", "SSRI", "Other"))
```

```{r MOSAIC satisfaction by type}
# keep

# Mosaic plot of user overall satisfaction with drug by drug type (SRI vs NRI)
x %>%
  filter(rating_type %in% c("rating")) %>%
  ggplot() +
  geom_mosaic(aes(product(type, rating_type),
                  weight = count,
                  fill = factor(given_score))) +
  theme_fivethirtyeight() +
  guides(fill = guide_legend("Rating", reverse = TRUE)) +
  coord_flip() +
  scale_fill_viridis_d() +
  theme(legend.position = "right", 
        legend.direction = "vertical",
        axis.text.y = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(size = 14),
        panel.background = element_blank(),
        plot.background = element_blank(),
        legend.background = element_blank(),
        axis.text = element_text(size = 16)) +
  ggtitle("Overall Satsifaction By Drug Type")
```

This mosaic plot shows that for the most part the three groups are fairly similar in terms of overall satisfaction ratings. The differences might be attributed to just random chance. 


Mosaic plot of user ratings of drug effectiveness and side effects by drug type (SRI vs NRIs)
```{r MOSAIC for SE and EFF} 
# keep

x %>% 
  ungroup() %>% 
  filter(rating_type %in% c("effectiveness", "sideEffects")) %>% 
  mutate(rating_type = case_when(
    rating_type == "effectiveness" ~ "User Rating of Effectiveness",
    TRUE ~ "User Rating of Side Effects")) %>% 
  ggplot() +
  geom_mosaic(aes(product(type, rating_type), 
                  weight = count, 
                  fill = factor(given_score)))+
  theme_fivethirtyeight() + 
  guides(fill = guide_legend("Rating",reverse = TRUE)) +
  coord_flip() + 
  facet_grid(. ~ rating_type) + 
  scale_fill_viridis_d() + 
  theme(legend.position = "right", 
        legend.direction = "vertical",
        axis.text.y = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        plot.background = element_blank(),
        legend.background = element_blank(),
        axis.text = element_text(size = 16),
        strip.background = element_blank()) + 
  ggtitle("Ratings of Effectiveness & Side Effects Across Drug Types")
```


Likewise, there does not appear to be any systematic differences in the distribution of ratings for perceived effectiveness or side effects between drug categories.

```{r cut 3WAY SCATTER}
# df %>% 
#   ggplot(aes(effectiveness, sideEffects, color = factor(rating))) +
#   geom_jitter(alpha = 0.6, width = 0.15, height = 0.15) +
#   # faceting doesn't really offer any additional insight
#   #facet_grid(.~type) +
#   xlab("Effectiveness Rating") +
#   ylab("Side Effects Rating") +
#   labs(color = "User Rating") +
#   scale_color_viridis_d() + 
#   theme(legend.position = "right",
#         legend.direction = "vertical",
#         legend.key = element_blank(),
#         plot.title = element_text(size=14),
#         panel.background = element_blank(),
#         plot.background = element_blank(),
#         legend.background = element_blank(),
#         axis.text = element_text(size = 16)) +
#   guides(colour = guide_legend(override.aes = list(alpha = 1, size = 2)),
#          reverse = TRUE) +
#   ggtitle("Effectiveness and Side Effects Rating with Overall User Rating")

```

```{r 3WAY heatmap}
df %>% 
  ggplot(aes(effectiveness, sideEffects, fill = rating)) +
  geom_tile() + 
  xlab("Effectiveness Rating") +
  ylab("Side Effects Rating") +
  labs(color = "User Rating") +
  scale_color_viridis_d() + 
  theme(legend.position = "right",
        legend.direction = "vertical",
        legend.key = element_blank(),
        plot.title = element_text(size=14),
        panel.background = element_blank(),
        plot.background = element_blank(),
        legend.background = element_blank(),
        axis.text = element_text(size = 16),
        panel.grid.major = element_blank()) +
  guides(colour = guide_legend(override.aes = list(alpha = 1, size = 2)),
         reverse = TRUE) +
  ggtitle("Effectiveness and Side Effects Rating with Overall User Satisfaction") + 
  guides(fill = guide_legend(title = "Satisfaction")) +
  scale_fill_viridis_c()
```

This heatmap shows how side effects and effectiveness are related to how satisfied the user is with their medication. There appears to be a trend that as effectiveness increases and side effects get less severe that overall satisfaction increases, which is unsurprising. However, there does seem to be some discontinuity. For example, average satisfaction level is considerably low despite effectiveness rating of 4 and a moderate side effects rating. 

***

## Model Creation 

We wanted to fit some models using our data to try and see if we could gain any more insight into how user satsifaction can be predicted using our drug data. The first model we looked at was an ordered logistic regression since our response variable in on a scale from 1 to 10. I created three models, which each model using side effects and effectiveness as predictors. The first model only uses those two, the second model takes into consideration drug type, and the third model takes into consideration the drug itself. The first model has the lowest AIC, which is a statistic produced from the model output used to compare against models. So even though it doesnt have the lowest residual deviance out of three models, it is the most interpretable model and lowest AIC, so we'll use that.

```{r ORDINAL LOGISTIC model creation}
df <- df %>% as.tibble()

# side effects
drugs_polr_se <- MASS::polr(factor(rating) ~ as.factor(sideEffects), data = df)

# effectiveness
drugs_polr_eff <- MASS::polr(factor(rating) ~ as.factor(effectiveness), data = df)


drugs_polr <- MASS::polr(factor(rating) ~ as.factor(effectiveness) + as.factor(sideEffects), data = df)

drugs_polr4 <- MASS::polr(factor(effectiveness) ~ as.factor(sideEffects), data = df)

drugs_polr2 <- MASS::polr(factor(rating) ~ as.factor(effectiveness) + as.factor(sideEffects) + as.factor(type), data = df)

drugs_polr3 <- MASS::polr(factor(rating) ~ as.factor(effectiveness) + as.factor(sideEffects) + as.factor(drug), data = df)
```

```{r}
# tidying data to plot nicely
drugs.polr.df <- data.frame(model.frame(drugs_polr), fitted.values(drugs_polr))

drugs.polr.long <- drugs.polr.df %>% gather(factor.rating., probability, X1:X10) %>% 
  mutate(factor.rating. = substring(factor.rating., 2))

drugs.polr.long$factor.rating. <- factor(drugs.polr.long$factor.rating.,
                                         levels = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10"))

drugs.polr.long$as.factor.sideEffects.f <- factor(drugs.polr.long$as.factor.sideEffects., 
                                                  levels = c("5","4","3","2","1"))

#ordinal.plot <- 
drugs.polr.long %>%
  ggplot(aes(as.numeric(factor.rating.), probability, col = as.factor.sideEffects.f)) +
  geom_line() +
  geom_point() + 
  facet_grid(as.factor.sideEffects.f ~ as.factor.effectiveness.) +
  xlab("Overall Satisfaction Rating") + ylab("Probability") + 
  labs(title = "Ordinal Logistic Model Probabilities")+
  guides(color = guides(col=FALSE)) + 
  scale_colour_viridis_d() +
  scale_x_continuous(breaks = seq(0,10,2), sec.axis = sec_axis(~.*1, "Effectiveness")) + 
  scale_y_continuous(sec.axis = sec_axis(~.*1, "Side Effects")) +
  theme(plot.subtitle = element_text(size = 8),
        axis.text.y.right = element_blank(),
        axis.text.x.top = element_blank(),
        panel.background = element_blank(),
        plot.background = element_blank(),
        legend.background = element_blank(),
        axis.text = element_text(size = 12),
        strip.background = element_blank()) 

#ggsave(ordinal.plot, filename="ordinal_plot.png")
```

This plot shows the probabilites from the ordinal model. We can see that the model generally predicts high satisfaction with improved effectiveness and side effects ratings. 


Multinomial Logit Model #1 (2 predictors): SatisfactionRating ~ Effectiveness + SideEffects
```{r}
multi_mod <- VGAM::vglm(factor(rating) ~ as.factor(effectiveness) + as.factor(sideEffects), data = df, family = "multinomial")

multi_mod.df <- data.frame(model.frame(multi_mod), fitted.values(multi_mod))

multi_mod.long <- multi_mod.df %>% gather(factor.rating., probability, X1:X10) %>% 
  mutate(factor.rating. = substring(factor.rating., 2))

multi_mod.long$factor.rating. <- factor(multi_mod.long$factor.rating., 
                                 levels = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10"))

multi_mod.long$as.factor.sideEffects.f <- factor(multi_mod.long$as.factor.sideEffects., 
                                          levels = c("5","4","3","2","1"))

#multi.plot <- 
multi_mod.long %>%
  ggplot(aes(as.numeric(factor.rating.), probability, col = as.factor.sideEffects.f)) +
  geom_line() +
  geom_point() + 
  facet_grid(as.factor.sideEffects.f ~ as.factor.effectiveness.) +
  xlab("Overall Satisfaction Rating") + ylab("Probability") + 
  labs(title = "Multinomial Logistic Model Probabilities")+
  guides(color = guides(col=FALSE)) + 
  scale_colour_viridis_d() +
  scale_x_continuous(breaks = seq(0,10,2), sec.axis = sec_axis(~.*1, "Effectiveness")) + 
  scale_y_continuous(sec.axis = sec_axis(~.*1, "Side Effects")) +
  theme(plot.subtitle = element_text(size = 8),
        axis.text.y.right = element_blank(),
        axis.text.x.top = element_blank(),
        panel.background = element_blank(),
        plot.background = element_blank(),
        legend.background = element_blank(),
        axis.text = element_text(size = 12),
        strip.background = element_blank()
  ) 

# ggsave(multi.plot, filename="multiplot.png")
```

Multinomial logit model 1 and 2 not very different based on AIC (1380.239 vs 1383.26 respectively), whereas model 3 has lowest deviance but considerably higher AIC (1879.28). Could go with multi_mod, since it has lowest AIC.

Show polr plot predicting effectiveness using side effects as predictor; how strongly do side effects predict perceived drug effectiveness?
```{r}
polr4.df <- data.frame(model.frame(drugs_polr4), fitted.values(drugs_polr4))
polr4.long <- polr4.df %>% gather(factor.effectiveness., probability, X1:X5) %>% 
  mutate(factor.effectiveness. = substring(factor.effectiveness., 2))
polr4.long$factor.effectiveness. <- factor(polr4.long$factor.effectiveness.,
                                           levels = c("1", "2", "3", "4", "5"))
polr4.long$as.factor.sideEffects. <- factor(polr4.long$as.factor.sideEffects., 
                                            levels = c("5","4","3","2","1"))

#polr4.plot <- 
polr4.long %>%
  ggplot(aes(as.numeric(factor.effectiveness.), probability, col = as.factor.sideEffects.)) +
  geom_line() +
  geom_point() + 
  facet_grid(~ as.factor.sideEffects.) +
  xlab("Perceived Effectiveness") + ylab("Probability") + 
  labs(title = "Ordinal Logistic Model Probabilities")+
  guides(color = guides(col=FALSE)) + 
  scale_colour_viridis_d() +
  scale_x_continuous(breaks = seq(1,5,1), sec.axis = sec_axis(~.*1, "Side Effects")) + 
  scale_y_continuous() +
  theme(plot.subtitle = element_text(size = 8),
        axis.text.y.right = element_blank(),
        axis.text.x.top = element_blank(),
        panel.background = element_blank(),
        plot.background = element_blank(),
        legend.background = element_blank(),
        axis.text = element_text(size = 12)) 
```

Show polr plot with only single predictor using Side Effects to predict Overall Satisfaction
```{r}
polr.se.df <- data.frame(model.frame(drugs_polr_se), fitted.values(drugs_polr_se))
polr.se.long <- polr.se.df %>% gather(factor.rating., probability, X1:X10) %>%
  mutate(factor.rating. = substring(factor.rating., 2))
polr.se.long$factor.rating. <- factor(polr.se.long$factor.rating.,
                                      levels = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10"))
polr.se.long$as.factor.sideEffects.f <- factor(polr.se.long$as.factor.sideEffects.,
                                               levels = c("5","4","3","2","1"))
```

```{r}
#polr.se.plot <- 
polr.se.long %>%
  ggplot(aes(as.numeric(factor.rating.), probability, col = as.factor.sideEffects.f)) +
  geom_line() +
  geom_point() + 
  facet_grid(~ as.factor.sideEffects.f) +
  xlab("Overall Satisfaction Rating") + ylab("Probability") + 
  labs(title = "Ordinal Logistic Model Probabilities")+
  guides(color = guides(col=FALSE)) + 
  scale_colour_viridis_d() +
  scale_x_continuous(breaks = seq(0,10,2), sec.axis = sec_axis(~.*1, "Side Effects")) + 
  scale_y_continuous() +
  theme(plot.subtitle = element_text(size = 8),
        axis.text.y.right = element_blank(),
        axis.text.x.top = element_blank(),
        panel.background = element_blank(),
        plot.background = element_blank(),
        legend.background = element_blank(),
        strip.background = element_blank(),
        axis.text = element_text(size = 12)) 
```


## Conclusions

1.  Identify predominant choice of antidepressant drug types and brands.

We found from our exploratory data analysis that SSRIs and SNRIs are by far the most frequently chosen classes of drugs to treat depression, with SSRIs being slightly more popular. Among SSRIs, the most commonly used drug is Lexapro, followed by Prozac, Paxil, and Zoloft. Wellbutrin and Effexor are the most commonly chosen SNRIs. While we did not examine the benefit/side effect tradeoff for individual medications, a possible cause that these drugs are the most popular is that they are the most effective while having the fewest side effects, or at least side effects that are manageable enough that the benefits they provide are worth the side effects. Another possible explanation is that the companies that manufacture these drugs may have the most resources to spend on marketing and advertising, and so they are the ones that patients ask their doctors about specifically when deciding on treatment options. That would cause certain drugs to be more common than others, even if they are not necessarily the most effective or give the highest ratings of patient satisfaction.

2.	Examine patients’ risk/benefit evaluations across varying treatment options.

We found that patients' evaluations of the effectiveness and side effects of SSRIs and SNRIs are remarkably similar, despite SSRIs being the more common choice. The distributions patient ratings across the two scales were almost exactly the same. In addition, we found that drugs in the "other" category also had a similar evaluation profile to those of SSRIs and SNRIs, although there seemed to be more observations on both the high and low end of each scale, wheres that SSRIs and SNRIs tended to have less extreme ratings. This could be due in part to the fact that "other" drugs account for only 14% of all cases, as well as the fact that the category potentially encompasses many varying classes of drugs, whereas the other two categories only account for one drug class each. We also found that SSRIs and SNRIs had similar overall satisfaction ratings, suggesting that there may not be a significant difference between the two classes of drugs when it comes to effectiveness, side effects, or overall satisfaction.


# TODO 
3.  Predict patients' overall satisfaction with a drug based on the drug's effectiveness and side effects.


## Limitations/Future Work

One of the main limitations of our analysis was the fact that we lumped together all patients who were being treated for depression, when in fact many of the patients were being treated for depression in addition to other conditions, e.g., anxiety, PTSD, bipolar disorder, etc. These patients may have had their evaluations of their treatement swayed by which of these conditions they were most focused on--for example, a patient may have given a decreased satisfaction rating even if the drug was very effective at treating depression, but was not effective at treating their main concern which was bipolar disorder. Another limitation is the fact that we do not have information on why the patient selected the treatment they did. If there was a variable that stated whether the patient specifically requested a certain prescription or whether their doctor suggested a particular treatment or there was some other reason, we would be able to draw some even more interesting conclusions. Finally, we sacrificed a little bit of clarity by grouping all drugs other than SSRIs and SNRIs into one category, but since we were mostly interested in comparing the two major categories, this decision seemed appropriate.

One thing we would have really liked to do was sentiment analysis on the actual text of the reviews left by patients to get a better sense of their overall satisfaction with their treatment. Unfortunately, none of the readily available packages that currently for such a task are well-configured for medical terminology, so we got some unusual results when we tried to use it in this particular context. 


# References

Anderson, I. M., Ferrier, I. N., Baldwin, R. C., Cowen, P. J., Howard, L., Lewis, G., & Tylee, A. 	(2008). Evidence-based guidelines for treating depressive disorders with antidepressants: 	a revision of the 2000 British Association for Psychopharmacology guidelines. Journal of 	Psychopharmacology, 22(4), 343-396.

Fortney, J. C., Pyne, J. M., Edlund, M. J., Stecker, T., Mittal, D., Robinson, D. E., & Henderson, 	K. L. (2011). Reasons for antidepressant nonadherence among veterans treated in primary 	care clinics. The Journal of Clinical Psychiatry, 72(6), 827-834.

McDonald, H. P., Garg, A. X., & Haynes, R. B. (2002). Interventions to enhance patient 		adherence to medication prescriptions: scientific review. JAMA, 288(22), 2868-2879.

Qaseem, A., Barry, M. J., & Kansagara, D. (2016). Nonpharmacologic versus pharmacologic 	treatment of adult patients with major depressive disorder: a clinical practice guideline 	from the American College of Physicians. Annals of Internal Medicine, 164(5), 350-359.

Sansone, R. A., & Sansone, L. A. (2012). Antidepressant adherence: are patients taking their 	medications?. Innovations in Clinical Neuroscience, 9(5-6), 41-6.

Won, E., Park, S. C., Han, K. M., Sung, S. H., Lee, H. Y., Paik, J. W., & Lee, K. J. (2014). 	Evidence-based, pharmacological treatment guideline for depression in Korea. Journal of 	Korean Medical Science, 29(4), 468-484.



```{r unused code}
#Multinomial Logit Model #2 (3 Predictors): SatisfactionRating ~ Effectiveness + SideEffects + DrugType
# m2 <- VGAM::vglm(factor(rating) ~ as.factor(effectiveness) + as.factor(sideEffects) + as.factor(type), data = df, family = "multinomial")
# 
# m2.df <- data.frame(model.frame(m2), fitted.values(m2))
# m2.long <- m2.df %>% gather(factor.rating., probability, X1:X10) %>% 
#   mutate(factor.rating. = substring(factor.rating., 2))
# 
# m2.long$factor.rating. <- factor(m2.long$factor.rating., levels = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10"
# ))
# 
# m2.long %>%
#   mutate(as.factor.effectiveness. = paste0("(E = ", as.factor.effectiveness.),
#          as.factor.sideEffects. = paste0("SE = ",as.factor.sideEffects., ")")) %>%
#   unite(col = unite, c(as.factor.effectiveness., as.factor.sideEffects.), sep = ", ") %>%
#   ggplot(aes(x = factor.rating., y = probability, col = as.factor.type.)) +
#   geom_point() +
#   facet_wrap(. ~ unite) +
#   theme(legend.position = "right",
#         legend.direction = "vertical") +
#   xlab("Overall Satisfaction Rating") + 
#   ylab("Probability") +
#   guides(color = guide_legend("Drug Type"))

#Multinomial Logit Model #3 (3 Predictors): SatisfactionRating ~ Effectiveness + SideEffects + DrugBrand

#m3 <- VGAM::vglm(factor(rating) ~ as.factor(effectiveness) + as.factor(sideEffects) + as.factor(drug), data = df, family = "multinomial")

#Plot multinomial model fits with fewer category levels

# m.df2 <- VGAM::vglm(factor(rating) ~ as.factor(effectiveness) + as.factor(sideEffects), data = df2, family = "multinomial")
# 
# summary(m.df2)
# 
# m.df2 <- data.frame(model.frame(m.df2), fitted.values(m.df2))
# m.df2.long <- m.df2 %>% gather(factor.rating., probability, X1:X10) %>%
#   mutate(factor.rating. = substring(factor.rating., 2))
# 
# m.df2.long$factor.rating. <- factor(m.df2.long$factor.rating., levels = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10"
# ))
# 
# levels(m.df2.long$as.factor.effectiveness.) <- c("Ineffective","Marginally \nEffective","Moderately \nEffective","Considerably \nEffective","Highly Effective")
# 
# m.df2.long %>% 
#   #mutate(as.factor.effectiveness. = paste0(as.factor.effectiveness.)) %>%
#   #as.factor.sideEffects. = paste0("SE = ",as.factor.sideEffects., ")")) %>%
#   #unite(col = unite, c(as.factor.effectiveness., as.factor.sideEffects.), sep = ", ") %>% 
#   ggplot(aes(as.numeric(factor.rating.), probability, col = as.factor.sideEffects.)) + 
#   geom_point() + 
#   geom_line() +
#   facet_grid(as.factor.sideEffects.~ as.factor.effectiveness.) +
#   xlab("Overall Satisfaction Rating") +
#   ylab("Probability") + 
#   theme()+
#   guides(color = FALSE) + 
#   scale_color_viridis_d() +
#   scale_x_continuous(breaks = seq(0,10,2))

# satis_perc <- df %>% 
#   ggplot(aes(effectiveness, fill = factor(rating))) +
#   geom_bar(position = "fill") +
#   theme(legend.position = "top",
#         legend.direction = "horizontal",
#         plot.subtitle = element_text(size = 8, color = "black"),
#         panel.background = element_blank(),
#         plot.background = element_blank(),
#         legend.background = element_blank(),
#         axis.text = element_text(size = letter_size),
#         axis.title = element_blank()) +
#   guides(fill = guide_legend(title = "Satisfaction", reverse = TRUE, nrow = 1)) +
#   ylab("Proportion") +
#   xlab("Effectiveness") + 
#   labs(title = "How Drugs Effectiveness Affects Satisfaction",
#        subtitle = "1 - Ineffective, 2 - Marginally Effective, 3 - Moderately Effective, 4 - Considerably Effective, 5 - Highly Effective") +
#   coord_flip() + 
#   scale_fill_viridis_d() +
#   ggtitle("Perceived Drug Effectiveness and Overall Satisfaction") 

# side_satis_plot <- df %>% 
#   ggplot(aes(factor(sideEffects), fill = factor(rating))) +
#   geom_bar(position = "fill") +
#   theme(legend.position = "top",
#         legend.direction = "horizontal",
#         panel.background = element_blank(),
#         plot.background = element_blank(),
#         legend.background = element_blank(),
#         axis.text = element_text(size = letter_size),
#         axis.title = element_blank()) +
#   guides(fill = FALSE) +
#   ylab("Proportion") +
#   xlab("Side Effects Ratings") + 
#   coord_flip() +
#   ggtitle("Drug Side Effects Ratings and Overall Satisfaction")+
#   scale_fill_viridis_d()

# For the report, use the one below

# recode = function(x) {
#   if(x < 3) {
#     return("Poor")
#   } else if(x == 3 | x == 4) {
#     return("Fair")
#   } else {
#     return("Excellent")
#   }
# }
# 
# df2 <- df
# for(i in 1:nrow(df2)) {
#   #df2$effectiveness[i] = recode(df2$effectiveness[i])
#   df2$sideEffects[i] = recode(df2$sideEffects[i])
# }

#side_effects_perc <- 
# df %>%
#   ggplot(aes(effectiveness, fill = factor(sideEffects))) +
#   geom_bar(position = "fill") + 
#   theme(legend.position = "top",
#         legend.direction = "horizontal",
#         panel.background = element_blank(),
#         plot.background = element_blank(),
#         legend.background = element_blank()) +
#   guides(fill = guide_legend(title = "Satisfaction", reverse = TRUE, nrow = 1)) +
#   ylab("Proportion") +
#   xlab("Effectiveness") + 
#   coord_flip() +
#   ggtitle("Perceived Drug Effectiveness and Side Effects") +
#   scale_fill_viridis_d()

#ggsave(side_effects_perc, filename = "side_effects_perc.png")
```